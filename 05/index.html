<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assignment 5</title>
    <style>
      html,
      body {
        background-color: black;
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
      }

      #loader {
        margin: 0;
        padding: 0;
        position: fixed;
        color: white;
        top: 50vh;
        left: 50vw;
        transform: translate(-50%, -50%); /* top and left target top left of text element, this adjusts for that offset so text is in center. */
        font-family: sans-serif;
        font-size: 2rem;
      }
    </style>

    <script
      async
      src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"
    ></script>

    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@latest/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@latest/examples/jsm/"
        }
      }
    </script>

    <script type="module">
      import * as THREE from "three";
      import { OrbitControls } from "three/addons/controls/OrbitControls.js";
      import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";
      import { AnaglyphEffect } from "three/addons/effects/AnaglyphEffect.js";
      import { Pane } from "https://cdn.jsdelivr.net/npm/tweakpane@4.0.5/dist/tweakpane.min.js";

      // Declare variables used for various items in scene.
      let renderer, controls, scene, camera, loader, pane, anaglyph;

      // ---- SETTINGS and HELPER for TWEAKPANE
      window.SCENE = {
        "anaglyph": false,
        "poly": null,
        "appa": null
      }

      // Defined as an async function as the calls to GLTFLoader are asynchronous - I only want to display items once everything is loaded.
      window.onload = async () => {
        // ---- SCENE SETUP
        // Create scene
        scene = new THREE.Scene();

        // Setup Camera
        let fov = 75;
        let ratio = window.innerWidth / window.innerHeight;
        let zNear = 0.1;
        let zFar = 10000;

        camera = new THREE.PerspectiveCamera(fov, ratio, zNear, zFar);
        camera.position.set(0, 3, 10);

        // Create renderer and add canvas to DOM.
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Light setup
        let ambientLight = new THREE.AmbientLight();
        scene.add(ambientLight);

        let directionalLight = new THREE.DirectionalLight(0xffffff, 5.0);
        directionalLight.position.set(10, 100, 10);
        scene.add(directionalLight);

        // Create anaglyph effect
        anaglyph = new AnaglyphEffect(renderer);
        anaglyph.setSize(window.innerWidth, window.innerHeight);

        // ---- LOAD MODELS
        loader = new GLTFLoader();

        // Load unedited 3D scan from polycam.
        await loadGLTFFile("UneditedAppa.glb", 40, 5, -3.5, 0, "poly");

        // Load edited 3D scan.
        await loadGLTFFile("Appa.glb", 40, -5, 0, 0, "appa");

        // ---- TWEAKPANE CONFIG
        // Enable tweakpane
        pane = new Pane();
        let sceneui = pane.addFolder({title: "Scene"});

        // Camera position controls
        sceneui.addBinding(directionalLight.position, "x", {min: -100, max: 100, label: "Light X"});
        sceneui.addBinding(directionalLight.position, "y", {min: -100, max: 100, label: "Light Y"});
        sceneui.addBinding(directionalLight.position, "z", {min: -100, max: 100, label: "Light Z"});

        sceneui.addBinding(window.SCENE, "anaglyph");

        
        // ---- ENABLE SCENE
        // Enable camera controls.
        controls = new OrbitControls(camera, renderer.domElement);
        
        // Hide loader after models are finished loading.
        let loaderElement = document.getElementById("loader");
        loaderElement.style.display = "none";

        animate();
      };

      // Custom wrapper function to simplify loading a gltf file.
      // Function is async and returns promise to ensure that animation loop doesn't begin until models are loaded.
      let loadGLTFFile = async (filename, scale = 1, x = 0, y = 0, z = 0, tweakReference) => {
        return new Promise((resolve) => {
          // Call load on gltf loader object.
          loader.load(filename, (gltf) => {
            var model = gltf.scenes[0].children[0];

            // Set scale
            model.scale.x = scale;
            model.scale.y = scale;
            model.scale.z = scale;

            // Apply translation
            model.translateX(x);
            model.translateY(y);
            model.translateZ(z);

            // Remove rotation - Objects still appears rotated as that is how the model of the scan output.
            model.quaternion.w = 1;
            model.quaternion.x = 0;
            model.quaternion.y = 0;
            model.quaternion.z = 0;

            // Update reference to model in tweakpane settings
            window.SCENE[tweakReference] = model;

            scene.add(gltf.scene);
            resolve();
          });
        });
      };

      let animate = () => {
        requestAnimationFrame(animate);

        controls.update();
        if (window.SCENE.anaglyph) {
          anaglyph.render(scene, camera);
        } else {
          renderer.render(scene, camera);
        }
      };
    </script>
  </head>
  <body><p id="loader">Loading...</p></body>
</html>
